# 通知ロール管理機能

ユーザーがDiscordのボタンUIを使って、通知ロールのON/OFFを自分で切り替えられる機能です。

## 機能概要

- `/notification` コマンドでボタン付きのメッセージを表示
- 「🔔 通知ON」ボタン: 通知ロールを付与
- 「🔕 通知OFF」ボタン: 通知ロールを削除
- Bot再起動後もボタンが機能する永続的なView
- ユーザーフレンドリーなエラーメッセージ

## セットアップ

### 1. ロールの作成

1. Discordサーバーで通知用のロールを作成（例：「お知らせ」）
2. ロールを右クリック→「ロールIDをコピー」

### 2. 環境変数の設定

`.env` ファイルに以下を追加：

```env
NOTIFICATION_ROLE_ID=123456789012345678
```

### 3. Bot権限の設定

Botに以下の権限を付与してください：

- **ロールの管理** (Manage Roles)
- **サーバーメンバーのインテント** (Server Members Intent)

**重要:** Botのロールは、管理対象のロールよりも**上位**に配置する必要があります。

### 4. Botの再起動

環境変数を設定したら、Botを再起動してください。

## 使い方

### ユーザー側

1. Discordで `/notification` コマンドを実行
2. 表示されたメッセージのボタンを押す
   - 「🔔 通知ON」: 通知ロールが付与される
   - 「🔕 通知OFF」: 通知ロールが削除される
3. ボタンを押すと、成功メッセージが表示される（本人にのみ表示）

### 管理者側

通知を送信したい場合：

1. 通知を送りたいチャンネルでメッセージを投稿
2. メッセージに `@お知らせ` （設定したロール名）をメンションすると、通知ONにしているユーザー全員に通知される

## トラブルシューティング

### ボタンを押してもエラーが出る

**原因1: Botにロール管理権限がない**
- サーバー設定 → ロール → Botのロール → 「ロールの管理」にチェック

**原因2: Botのロールが管理対象ロールより下位にある**
- サーバー設定 → ロール → Botのロールを管理対象ロールより上にドラッグ

**原因3: ロールIDが間違っている**
- `.env` ファイルの `NOTIFICATION_ROLE_ID` を確認
- ロールを右クリック → 「ロールIDをコピー」で正しいIDを取得

### Bot再起動後にボタンが動かない

この機能は永続的なViewを使用しているため、Bot再起動後もボタンは動作するはずです。
もし動作しない場合は、以下を確認してください：

- Bot起動時のログに「通知ロールViewを登録しました」と表示されているか
- `NOTIFICATION_ROLE_ID` が正しく設定されているか

## 実装詳細

### ファイル構成

```
features/notification_role/
├── __init__.py          # モジュールの公開API
├── commands.py          # コマンドとボタンUI実装
├── embeds.py           # Embed作成ロジック
└── README.md           # このファイル
```

### 主要コンポーネント

- **`NotificationRoleView`**: 永続的なボタンUIを提供するViewクラス
- **`notification_role_command_handler`**: `/notification` コマンドのハンドラ
- **`create_notification_role_embed`**: 説明用Embedを作成
- **`create_success_embed`**: 成功メッセージEmbedを作成
- **`create_error_embed`**: エラーメッセージEmbedを作成

### 永続的なView

`timeout=None` と `custom_id` を使用して、Bot再起動後もボタンが機能するようにしています。
`bot.add_view()` で起動時にViewを登録することで、永続化を実現しています。

## 今後の拡張案

- 複数のロールを管理できるようにする
- ロールごとに異なるチャンネルで通知を管理
- 管理者用のロール設定コマンド（`.env` を編集せずに設定可能に）

