## ğŸ§© ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆæ¦‚è¦

- **è¨€èª**: Python 3.11
- **å®Ÿè¡ŒåŸºç›¤**: AWS ECS Fargate
- **CI/CD**: GitHub Actionsï¼ˆOIDCï¼‰
- **ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†**: Amazon ECR
- **èªè¨¼æƒ…å ±ç®¡ç†**: AWS Secrets Manager
- **ãƒ­ã‚°ç®¡ç†**: Amazon CloudWatch Logs

---

## Bot ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Discord Bot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰æ§‹æˆã¨ã€Discord / å¤–éƒ¨ API ã¨ã®é–¢ä¿‚ã€‚

```mermaid
flowchart TB
    subgraph Entry["ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ"]
        Bot["bot.py<br/>Discord Bot"]
        CLI["main.py<br/>CLIï¼ˆå¾Œæ–¹äº’æ›ï¼‰"]
    end

    subgraph Features["features/"]
        Wrapped["wrapped<br/>osu! 2025 Wrapped"]
        NotifRole["notification_role<br/>é€šçŸ¥ON/OFF"]
        Broadcast["broadcast<br/>ä¸€æ–‰é€ä¿¡"]
        ConfigReload["config_reload<br/>è¨­å®šå†èª­è¾¼"]
        TwitchNotif["twitch_notification<br/>Twitch é…ä¿¡é€šçŸ¥"]
    end

    subgraph Core["core/"]
        Config["config"]
        OsuAPI["osu_api"]
        TwitchAPI["twitch_api"]
        Utils["utils"]
        Logger["logger"]
    end

    subgraph External["å¤–éƒ¨"]
        DiscordAPI["Discord API"]
        Osu["osu! API"]
        Twitch["Twitch API"]
    end

    Bot --> Wrapped
    Bot --> NotifRole
    Bot --> TwitchNotif
    Bot --> Broadcast
    Bot --> ConfigReload
    CLI --> Wrapped

    Wrapped --> OsuAPI
    Wrapped --> Utils
    NotifRole --> Config
    Broadcast --> Config
    ConfigReload --> Config
    TwitchNotif --> TwitchAPI
    TwitchNotif --> Config

    OsuAPI --> Osu
    TwitchAPI --> Twitch
    Bot --> DiscordAPI
```

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | å½¹å‰² |
|----------|------|
| **bot.py** | `commands.Bot` ã®ã‚¨ãƒ³ãƒˆãƒªã€‚ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²ã€`on_ready` ã§ View ç™»éŒ²ãƒ»Twitch ã‚¿ã‚¹ã‚¯èµ·å‹•ã€‚`main.py` ã¯ CLI ç”¨ï¼ˆwrapped ã®ã¿ï¼‰ |
| **features/** | æ©Ÿèƒ½ã”ã¨ã« `commands`ï¼ˆ+ `data` / `embeds` / `tasks`ï¼‰ã€‚`wrapped` ã¯ osu!ã€`twitch_notification` ã¯ `TwitchNotificationTask` ã§ãƒãƒ¼ãƒªãƒ³ã‚° |
| **core/** | å…±é€š: `config`ï¼ˆç’°å¢ƒå¤‰æ•°ï¼‰ã€`osu_api` / `twitch_api`ã€`utils`ã€`logger` |

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆã¨æ¥ç¶šé–¢ä¿‚ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©ãƒ»CI/CDï¼‰ã€‚

```mermaid
flowchart TB
    subgraph GitHub["GitHub"]
        Repo["Repository<br/>Homuhomu-DiscordBot"]
    end

    subgraph GHA["GitHub Actions"]
        Pipeline["CI/CD Pipeline"]
    end

    subgraph AWS["AWS"]
        ECR["Amazon ECR<br/>Docker Image :SHA"]
        TD["ECS Task Definition"]
        SVC["ECS Service<br/>Fargate"]
        Task["ECS Task<br/>Discord Bot å®Ÿè¡Œ"]
        CW["CloudWatch Logs"]
        SM["Secrets Manager"]
    end

    Discord["Discord"]

    Repo -->|"push (main)"| Pipeline
    Pipeline -->|"build & push"| ECR
    Pipeline -->|"deploy"| TD
    ECR --> TD
    TD --> SVC
    SVC --> Task
    SM -.->|"ç’°å¢ƒå¤‰æ•°"| Task
    Task -->|"ãƒ­ã‚°"| CW
    Task -->|"æ¥ç¶š"| Discord
```

---

## CI/CD ãƒ•ãƒ­ãƒ¼å›³

`main` ã¸ã® push ã‹ã‚‰ Bot ç¨¼åƒã¾ã§ã®å‡¦ç†é †åºã€‚

```mermaid
flowchart LR
    A["â‘  push"] --> B["â‘¡ OIDC"]
    B --> C["â‘¢ build"]
    C --> D["â‘£ ECR push"]
    D --> E["â‘¤ Task Def"]
    E --> F["â‘¥ ECS æ›´æ–°"]
    F --> G["â‘¦ Bot Online"]
```

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ |
|----------|------|
| â‘  | `main` ã¸ push |
| â‘¡ | OIDC ã§ AWS AssumeRole |
| â‘¢ | Docker build |
| â‘£ | ECR ã¸ pushï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ `:commit-SHA`ï¼‰ |
| â‘¤ | Task Definition ç”Ÿæˆï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ URI å·®ã—æ›¿ãˆï¼‰ |
| â‘¥ | ECS Service æ›´æ–°ï¼ˆæ–°ã‚¿ã‚¹ã‚¯å®šç¾©ã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰ |
| â‘¦ | ã‚¿ã‚¹ã‚¯èµ·å‹•ã€Discord Bot Online |

---

## é‹ç”¨ãƒ•ãƒ­ãƒ¼å›³

### â‘  é€šå¸¸é‹ç”¨ãƒ•ãƒ­ãƒ¼ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´ â†’ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

```mermaid
flowchart LR
    A["ã‚³ãƒ¼ãƒ‰å¤‰æ›´"] --> B["push<br/>main"]
    B --> C["GHA èµ·å‹•"]
    C --> D["build<br/>ECR push"]
    D --> E["ECS æ›´æ–°"]
    E --> F["æ–°ã‚¿ã‚¹ã‚¯èµ·å‹•<br/>æ—§ã‚¿ã‚¹ã‚¯åœæ­¢"]
    F --> G["Bot Online"]
```

| ã‚¹ãƒ†ãƒƒãƒ— | èª¬æ˜ |
|----------|------|
| ã‚³ãƒ¼ãƒ‰å¤‰æ›´ | `main` å‘ã‘ã« PR merge ã¾ãŸã¯ç›´æ¥ push |
| push | `main` ã¸ã® push ã§ `deploy.yml` ãŒãƒˆãƒªã‚¬ãƒ¼ |
| GHA èµ·å‹• | OIDC â†’ build â†’ ECR push â†’ Task Def ç”Ÿæˆ â†’ ECS Service æ›´æ–° |
| ECS æ›´æ–° | æ–°ã‚¿ã‚¹ã‚¯å®šç¾©ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã€`wait-for-service-stability` ã§å®‰å®šåŒ–ã¾ã§å¾…æ©Ÿ |
| æ–°ã‚¿ã‚¹ã‚¯èµ·å‹• | æ–°ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã€æ—§ã‚¿ã‚¹ã‚¯ãŒ Drain å¾Œã«åœæ­¢ |
| Bot Online | æ–°ã‚¿ã‚¹ã‚¯ã‹ã‚‰ Discord ã«å†æ¥ç¶šã€ç¨¼åƒç¶™ç¶š |

---

### â‘¡ èµ·å‹•æ™‚ãƒ•ãƒ­ãƒ¼ï¼ˆTask èµ·å‹• ã€œ Bot Readyï¼‰

```mermaid
flowchart LR
    A["ECS Task èµ·å‹•"] --> B["ã‚³ãƒ³ãƒ†ãƒŠ<br/>èµ·å‹•"]
    B --> C["Secrets å–å¾—"]
    C --> D["Discord<br/>æ¥ç¶š"]
    D --> E["Bot Ready"]
```

| ã‚¹ãƒ†ãƒƒãƒ— | èª¬æ˜ |
|----------|------|
| ECS Task èµ·å‹• | Fargate ãŒã‚³ãƒ³ãƒ†ãƒŠç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºä¿ã— `docker run` ç›¸å½“ã‚’å®Ÿè¡Œ |
| ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹• | `python bot.py` é–‹å§‹ã€‚Execution Role ã§ Secrets Manager ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’æ³¨å…¥ |
| Secrets å–å¾— | `DISCORD_BOT_TOKEN` ç­‰ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã« |
| Discord æ¥ç¶š | Discord Gateway ã«æ¥ç¶šã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ â†’ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«é·ç§» |
| Bot Ready | ã‚³ãƒãƒ³ãƒ‰ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãŒå¯èƒ½ãªçŠ¶æ…‹ |

---

### â‘¢ éšœå®³æ™‚ãƒ•ãƒ­ãƒ¼ï¼ˆBot ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ï¼‰

```mermaid
flowchart LR
    A["Bot ã‚¯ãƒ©ãƒƒã‚·ãƒ¥"] --> B["ã‚³ãƒ³ãƒ†ãƒŠ<br/>çµ‚äº†"]
    B --> C["ECS æ¤œçŸ¥"]
    C --> D["æ–°ã‚¿ã‚¹ã‚¯<br/>èµ·å‹•"]
    D --> E["â‘¡ èµ·å‹•æ™‚ãƒ•ãƒ­ãƒ¼"]
    E --> F["Bot Online"]
```

| ã‚¹ãƒ†ãƒƒãƒ— | èª¬æ˜ |
|----------|------|
| Bot ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ | æœªå‡¦ç†ä¾‹å¤–ãƒ»OOMãƒ»ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ãªã©ã§ã‚³ãƒ³ãƒ†ãƒŠãŒ exit |
| ã‚³ãƒ³ãƒ†ãƒŠçµ‚äº† | çµ‚äº†ã‚³ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ã€ã‚¿ã‚¹ã‚¯ãŒ STOPPED ã« |
| ECS æ¤œçŸ¥ | Service ã® `desiredCount` ã¨å®Ÿã‚¿ã‚¹ã‚¯æ•°ã‚’æ¯”è¼ƒã—ä¸è¶³ã‚’æ¤œçŸ¥ |
| æ–°ã‚¿ã‚¹ã‚¯èµ·å‹• | åŒä¸€ã‚¿ã‚¹ã‚¯å®šç¾©ã§æ–°ã‚¿ã‚¹ã‚¯ã‚’èµ·å‹•ï¼ˆâ‘¡ èµ·å‹•æ™‚ãƒ•ãƒ­ãƒ¼ã¨åŒã˜ï¼‰ |
| Bot Online | æ–°ã‚¿ã‚¹ã‚¯ã‹ã‚‰ Discord ã«å†æ¥ç¶šã€è‡ªå‹•å¾©æ—§ |

---

### â‘£ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ãƒ•ãƒ­ãƒ¼ï¼ˆå®‰å…¨è£…ç½®ï¼‰

```mermaid
flowchart LR
    A["Deploy é–‹å§‹"] --> B{"Build /<br/>ECR / ECS"}
    B -->|"å¤±æ•—"| C["GHA å¤±æ•—"]
    C --> D["æ—§ã‚¿ã‚¹ã‚¯<br/>ç¶™ç¶šç¨¼åƒ"]
    D --> E["æœ¬ç•ªå½±éŸ¿ãªã—"]
    B -->|"æˆåŠŸ"| F["æ–°ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†<br/>Bot Online"]
```

| ã‚¹ãƒ†ãƒƒãƒ— | èª¬æ˜ |
|----------|------|
| Deploy é–‹å§‹ | push ã«ä¼´ã„ GHA ã® build / ECR push / ECS æ›´æ–°ã®ã„ãšã‚Œã‹ã‚’å®Ÿè¡Œ |
| å¤±æ•— | ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã€ECR  push å¤±æ•—ã€ECS ã®å®‰å®šåŒ–å¤±æ•—ï¼ˆunhealthy ç­‰ï¼‰ |
| GHA å¤±æ•— | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã€è©²å½“ã‚¸ãƒ§ãƒ–ãŒèµ¤ããªã‚‹ |
| æ—§ã‚¿ã‚¹ã‚¯ç¶™ç¶š | ECS ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¦ã„ãªã‘ã‚Œã°**æ—¢å­˜ã‚¿ã‚¹ã‚¯ã¯ãã®ã¾ã¾**ã€‚æ–°ã‚¿ã‚¹ã‚¯å®šç¾©ã¸ã®åˆ‡ã‚Šæ›¿ãˆã¯è¡Œã‚ã‚Œãªã„ |
| æœ¬ç•ªå½±éŸ¿ãªã— | å£Šã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ»å®šç¾©ãŒæœ¬ç•ªã«åæ˜ ã•ã‚Œãšã€ç¾è¡Œ Bot ãŒç¨¼åƒã—ç¶šã‘ã‚‹ |

---

### â‘¤ Secrets æ›´æ–°ãƒ•ãƒ­ãƒ¼ï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ï¼‰

```mermaid
flowchart LR
    A["Secrets Manager<br/>ã§å€¤æ›´æ–°"] --> B["å¼·åˆ¶æ–°è¦<br/>ãƒ‡ãƒ—ãƒ­ã‚¤"]
    B --> C["æ—§ã‚¿ã‚¹ã‚¯åœæ­¢<br/>æ–°ã‚¿ã‚¹ã‚¯èµ·å‹•"]
    C --> D["èµ·å‹•æ™‚ã«<br/>æ–° Secret å–å¾—"]
    D --> E["Bot å†èµ·å‹•å®Œäº†"]
```

| ã‚¹ãƒ†ãƒƒãƒ— | èª¬æ˜ |
|----------|------|
| Secrets Manager ã§å€¤æ›´æ–° | ã‚³ãƒ³ã‚½ãƒ¼ãƒ« or CLI ã§ Token / API Key ãªã©ã‚’æ›´æ–° |
| å¼·åˆ¶æ–°è¦ãƒ‡ãƒ—ãƒ­ã‚¤ | ECS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã®å¼·åˆ¶ã€ã‚’å®Ÿè¡Œã€‚ã‚¿ã‚¹ã‚¯å®šç¾©ã®å¤‰æ›´ã¯ä¸è¦ |
| æ—§ã‚¿ã‚¹ã‚¯åœæ­¢ / æ–°ã‚¿ã‚¹ã‚¯èµ·å‹• | å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯ãŒåœæ­¢ã—ã€æ–°ã‚¿ã‚¹ã‚¯ãŒèµ·å‹•ã€‚**èµ·å‹•æ™‚**ã« Secrets ã‚’å†å–å¾—ã™ã‚‹ãŸã‚æ–°å€¤ãŒåæ˜ ã•ã‚Œã‚‹ |
| èµ·å‹•æ™‚ã«æ–° Secret å–å¾— | æ–°ã‚¿ã‚¹ã‚¯ã®åˆå›èµ·å‹•ã§ Secrets Manager ã‹ã‚‰æœ€æ–°å€¤ã‚’å–å¾— |
| Bot å†èµ·å‹•å®Œäº† | æ–°èªè¨¼æƒ…å ±ã§ Discord ç­‰ã«å†æ¥ç¶šã€ç¨¼åƒå†é–‹ |

> **æ³¨æ„**: å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯ã¯ Secret ã®ã€Œèµ·å‹•æ™‚ã‚³ãƒ”ãƒ¼ã€ã‚’æŒã¤ã ã‘ãªã®ã§ã€SM ã‚’æ›´æ–°ã—ã¦ã‚‚**å†èµ·å‹•ã™ã‚‹ã¾ã§**æ–°å€¤ã¯åæ˜ ã•ã‚Œãªã„ã€‚

---

### â‘¥ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆå³æ™‚å¾©æ—§ï¼‰

```mermaid
flowchart LR
    A["å•é¡Œæ¤œçŸ¥"] --> B{"å¾©æ—§æ‰‹æ®µ"}
    B -->|"A"| C["git revert<br/>push"]
    B -->|"B"| D["å‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã§<br/>æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤"]
    C --> E["GHA ã§<br/>æ—§ã‚³ãƒ¼ãƒ‰å†ãƒ‡ãƒ—ãƒ­ã‚¤"]
    D --> F["Task Def ã‚’<br/>æ—§ã‚¤ãƒ¡ãƒ¼ã‚¸ URI ã«"]
    E --> G["æ—§ç‰ˆã‚¿ã‚¹ã‚¯èµ·å‹•"]
    F --> G
    G --> H["å¾©æ—§å®Œäº†"]
```

| æ‰‹æ®µ | æ‰‹é † |
|------|------|
| **A. revert push** | å•é¡Œã®ã‚³ãƒŸãƒƒãƒˆã‚’ `git revert` ã—ã¦ `main` ã« push â†’ é€šå¸¸ã® deploy ãŒèµ°ã‚Šã€**revert æ¸ˆã¿ã‚³ãƒ¼ãƒ‰**ã®æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ ECS ãŒæ›´æ–°ã•ã‚Œã‚‹ |
| **B. å‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã§æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤** | 1) ECR ã§å‰å›æ­£å¸¸ã ã£ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã® URIï¼ˆ`:commit-SHA`ï¼‰ã‚’ç¢ºèª<br/>2) `ecs/task-definition.json` ã® `image` ã‚’ãã® URI ã«ä¸€æ™‚å¤‰æ›´ã™ã‚‹ã‹ã€AWS CLI ã§ã€Œå‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ãŸã‚¿ã‚¹ã‚¯å®šç¾©ã€ã‚’ç™»éŒ²<br/>3) ECS Service ã‚’ãã®ã‚¿ã‚¹ã‚¯å®šç¾©ã§æ›´æ–°ã—ã€Œå¼·åˆ¶æ–°è¦ãƒ‡ãƒ—ãƒ­ã‚¤ã€ |

| ã‚¹ãƒ†ãƒƒãƒ— | èª¬æ˜ |
|----------|------|
| å•é¡Œæ¤œçŸ¥ | ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ä¸å…·åˆãƒ»Discord å´ã‚¨ãƒ©ãƒ¼ãƒ»CloudWatch ãƒ­ã‚°ãªã©ã§ç•°å¸¸ã‚’æ¤œçŸ¥ |
| å¾©æ—§æ‰‹æ®µ | ä¸Šè¨˜ A ã¾ãŸã¯ B ã‚’é¸æŠã€‚B ã¯ã‚³ãƒ¼ãƒ‰ã‚’è§¦ã‚‰ãšã€éå»ã®ã€Œå‹•ã„ã¦ã„ãŸã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã¸æˆ»ã™å ´åˆã«åˆ©ç”¨ |
| æ—§ç‰ˆã‚¿ã‚¹ã‚¯èµ·å‹• | æ—§ã‚³ãƒ¼ãƒ‰ï¼æ—§ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚¹ã‚¯ãŒèµ·å‹•ã—ã€Discord Bot ãŒæ­£å¸¸å‹•ä½œã™ã‚‹çŠ¶æ…‹ã«æˆ»ã‚‹ |
| å¾©æ—§å®Œäº† | äº‹å¾Œã§åŸå› ä¿®æ­£ã—ã€æ”¹ã‚ã¦ `main` ã« push ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ |

---

## å…¨ä½“å›³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          GitHub               â”‚
â”‚  Repository (Homuhomu-DiscordBot)
â”‚                                â”‚
â”‚  - bot.py                      â”‚
â”‚  - Dockerfile                  â”‚
â”‚  - ecs/task-definition.json    â”‚
â”‚  - .github/workflows/deploy.ymlâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ push (main)
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        GitHub Actions          â”‚
â”‚  CI / CD Pipeline              â”‚
â”‚                                â”‚
â”‚  1. OIDCã§AWS AssumeRole       â”‚
â”‚  2. Docker build               â”‚
â”‚  3. ECRã¸push (commit SHA)     â”‚
â”‚  4. Task Definitionç”Ÿæˆ        â”‚
â”‚  5. ECS Serviceæ›´æ–°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AWS                 â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Amazon ECR       â”‚  â”‚
â”‚  â”‚  Docker Image Registry  â”‚  â”‚
â”‚  â”‚  - homuhomu-discord-bot â”‚  â”‚
â”‚  â”‚    :<commit SHA>        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                â”‚
â”‚              â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ECS Task Definition   â”‚  â”‚
â”‚  â”‚  (Gitç®¡ç†ãƒ»è‡ªå‹•ç”Ÿæˆ)    â”‚  â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚  - Image URI (SHA)       â”‚ â”‚
â”‚  â”‚  - CPU / Memory          â”‚ â”‚
â”‚  â”‚  - Secrets ARN           â”‚ â”‚
â”‚  â”‚  - Logè¨­å®š               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                â”‚
â”‚              â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ECS Service           â”‚  â”‚
â”‚  â”‚  (Fargate)              â”‚  â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚  - desiredCount = 1     â”‚  â”‚
â”‚  â”‚  - è‡ªå‹•å†èµ·å‹•            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                â”‚
â”‚              â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ECS Task (Fargate)    â”‚  â”‚
â”‚  â”‚  Discord Bot å®Ÿè¡Œ       â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚  ç’°å¢ƒå¤‰æ•°ï¼š              â”‚  â”‚
â”‚  â”‚   - DISCORD_BOT_TOKEN   â”‚  â”‚
â”‚  â”‚   - OSU / Twitch etc.   â”‚  â”‚
â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚  ãƒ­ã‚° â†’ CloudWatch Logs â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                â”‚
â”‚              â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   CloudWatch Logs       â”‚  â”‚
â”‚  â”‚  /ecs/homuhomu-...      â”‚  â”‚
â”‚  â”‚  - èµ·å‹•ãƒ­ã‚°             â”‚  â”‚
â”‚  â”‚  - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Secrets Manager       â”‚  â”‚
â”‚  â”‚  - Discord Bot Token    â”‚  â”‚
â”‚  â”‚  - API Keys             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Discord              â”‚
â”‚  - Bot Online                 â”‚
â”‚  - ã‚³ãƒãƒ³ãƒ‰å¿œç­”               â”‚
â”‚  - ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 


```
osu2025-wrapped/
â”œâ”€â”€ bot.py                    # Discord Botã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ main.py                   # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ç‰ˆã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰
â”œâ”€â”€ requirements.txt          # Pythonä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
â”œâ”€â”€ .env                      # ç’°å¢ƒå¤‰æ•°ï¼ˆgitignoreå¯¾è±¡ï¼‰
â”œâ”€â”€ .env.example              # ç’°å¢ƒå¤‰æ•°ã®ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ.gitignoreå¯¾è±¡ï¼‰
â”œâ”€â”€ README.md                 # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â”œâ”€â”€ documents/                # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”œâ”€â”€ README.md            # è©³ç´°ãªREADME
â”‚   â””â”€â”€ PROJECT_STRUCTURE.md # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã¨å®Ÿè£…æ–¹é‡ï¼‰
â”‚
â”œâ”€â”€ core/                     # ã‚³ã‚¢æ©Ÿèƒ½ãƒ»å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒª
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ osu_api.py           # osu! APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆmain.pyã‹ã‚‰ç§»è¡Œäºˆå®šï¼‰
â”‚   â”œâ”€â”€ utils.py             # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€è¨ˆç®—ãªã©ï¼‰
â”‚   â””â”€â”€ config.py            # è¨­å®šç®¡ç†
â”‚
â”œâ”€â”€ features/                 # æ©Ÿèƒ½ã”ã¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ wrapped/              # osu! 2025 Wrappedæ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ commands.py      # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å®šç¾©
â”‚   â”‚   â”œâ”€â”€ embeds.py        # Embedä½œæˆãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â””â”€â”€ data.py          # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚
â”‚   â””â”€â”€ [å°†æ¥ã®æ©Ÿèƒ½]/         # ä¾‹: beatmap_search, user_stats, etc.
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ commands.py
â”‚       â”œâ”€â”€ embeds.py
â”‚       â””â”€â”€ data.py
â”‚
â””â”€â”€ tests/                    # ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆå°†æ¥è¿½åŠ äºˆå®šï¼‰
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ test_core/
    â””â”€â”€ test_features/
```

## å®Ÿè£…æ–¹é‡

### 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã®åŸå‰‡

- **æ©Ÿèƒ½ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: å„æ©Ÿèƒ½ã¯`features/`é…ä¸‹ã®ç‹¬è‡ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
- **ã‚³ã‚¢æ©Ÿèƒ½ã®åˆ†é›¢**: å…±é€šã§ä½¿ç”¨ã•ã‚Œã‚‹æ©Ÿèƒ½ï¼ˆAPIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãªã©ï¼‰ã¯`core/`ã«é…ç½®
- **ä¾å­˜é–¢ä¿‚ã®æ˜ç¢ºåŒ–**: æ©Ÿèƒ½é–“ã®ä¾å­˜ã¯æœ€å°é™ã«ã—ã€`core/`ã‚’é€šã˜ã¦å…±é€šæ©Ÿèƒ½ã‚’ä½¿ç”¨

### 2. ã‚³ãƒ¼ãƒ‰æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³

å„æ©Ÿèƒ½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã‚’æ¨å¥¨ã—ã¾ã™ï¼š

```
features/[æ©Ÿèƒ½å]/
â”œâ”€â”€ __init__.py           # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¬é–‹API
â”œâ”€â”€ commands.py           # Discordã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å®šç¾©
â”œâ”€â”€ embeds.py            # Discord Embedä½œæˆãƒ­ã‚¸ãƒƒã‚¯
â”œâ”€â”€ data.py              # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
â””â”€â”€ models.py            # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```

**è²¬å‹™ã®åˆ†é›¢**:
- `commands.py`: Discordã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- `embeds.py`: Discord Embedã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
- `data.py`: APIå‘¼ã³å‡ºã—ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

### 3. å‘½åè¦å‰‡

- **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå**: `snake_case`ï¼ˆä¾‹: `wrapped`, `beatmap_search`ï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«å**: `snake_case`ï¼ˆä¾‹: `commands.py`, `osu_api.py`ï¼‰
- **ã‚¯ãƒ©ã‚¹å**: `PascalCase`ï¼ˆä¾‹: `OsuAPIClient`, `WrappedCommand`ï¼‰
- **é–¢æ•°å**: `snake_case`ï¼ˆä¾‹: `get_user_stats`, `create_wrapped_embed`ï¼‰
- **å®šæ•°**: `UPPER_SNAKE_CASE`ï¼ˆä¾‹: `BASE_URL`, `MAX_RESULTS`ï¼‰

### 4. ã‚³ãƒãƒ³ãƒ‰è¿½åŠ ã®æ‰‹é †

æ–°ã—ã„æ©Ÿèƒ½ï¼ˆã‚³ãƒãƒ³ãƒ‰ï¼‰ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼š

1. **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ**: `features/[æ©Ÿèƒ½å]/`ã‚’ä½œæˆ
2. **å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ**: `__init__.py`, `commands.py`, `embeds.py`, `data.py`
3. **ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…**: `commands.py`ã«ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å®šç¾©
4. **Botã¸ã®ç™»éŒ²**: `bot.py`ã§ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ç™»éŒ²

**ä¾‹: æ–°ã—ã„æ©Ÿèƒ½ã€Œbeatmap_searchã€ã‚’è¿½åŠ ã™ã‚‹å ´åˆ**

```python
# features/beatmap_search/commands.py
from discord import app_commands
from discord.ext import commands
from .data import search_beatmap
from .embeds import create_beatmap_embed

@commands.hybrid_command(name="beatmap")
@app_commands.describe(query="æ¤œç´¢ã‚¯ã‚¨ãƒª")
async def beatmap_command(ctx: commands.Context, query: str):
    """è­œé¢ã‚’æ¤œç´¢ã™ã‚‹"""
    await ctx.defer()
    
    try:
        beatmap_data = await search_beatmap(query)
        embed = create_beatmap_embed(beatmap_data)
        await ctx.send(embed=embed)
    except Exception as e:
        await ctx.send(f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}")

# bot.py
from features.beatmap_search.commands import beatmap_command
bot.add_command(beatmap_command)
```

### 5. å…±é€šæ©Ÿèƒ½ã®ä½¿ç”¨

`core/`é…ä¸‹ã®æ©Ÿèƒ½ã¯ã€ã™ã¹ã¦ã®æ©Ÿèƒ½ã‹ã‚‰ä½¿ç”¨ã§ãã¾ã™ï¼š

```python
# features/wrapped/data.py
from core.osu_api import OsuAPIClient
from core.config import get_osu_credentials

def get_user_stats(username: str):
    client_id, client_secret = get_osu_credentials()
    client = OsuAPIClient(client_id, client_secret)
    # ...
```

### 6. è¨­å®šç®¡ç†

ç’°å¢ƒå¤‰æ•°ã‚„è¨­å®šã¯`core/config.py`ã§ä¸€å…ƒç®¡ç†ï¼š

```python
# core/config.py
import os
from dotenv import load_dotenv

load_dotenv()

def get_osu_credentials():
    return (
        os.getenv('OSU_CLIENT_ID'),
        os.getenv('OSU_CLIENT_SECRET')
    )

def get_discord_token():
    return os.getenv('DISCORD_BOT_TOKEN')
```

### 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- **APIã‚¨ãƒ©ãƒ¼**: `core/osu_api.py`ã§çµ±ä¸€çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **ã‚³ãƒãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼**: å„`commands.py`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
- **ãƒ­ã‚°å‡ºåŠ›**: ã‚¨ãƒ©ãƒ¼ã¯å¿…ãšãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆå°†æ¥ã€ãƒ­ã‚®ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥äºˆå®šï¼‰

### 8. éåŒæœŸå‡¦ç†

- **APIå‘¼ã³å‡ºã—**: é•·æ™‚é–“ã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€`asyncio`ã‚’ä½¿ç”¨ã—ã¦éåŒæœŸå®Ÿè¡Œ
- **ã‚³ãƒãƒ³ãƒ‰å‡¦ç†**: Discord Botã®ã‚³ãƒãƒ³ãƒ‰ã¯å…¨ã¦`async/await`ã‚’ä½¿ç”¨
- **ãƒ‡ãƒ•ã‚¡ãƒ¼**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã¯`ctx.defer()`ã¾ãŸã¯`interaction.response.defer()`ã‚’ä½¿ç”¨
